---

AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Merged Network Mapping Stack: Combines public and private VPCs, peering, transit gateway,
  routing, IGW, subnets, route tables, VPC endpoints, NAT Gateway, EC2 instances (SSM only), and Elastic IP.

Parameters:

  VpcCidrPublic:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for the public VPC

  VpcCidrPrivate:
    Type: String
    Default: 10.1.0.0/16
    Description: CIDR block for the private VPC

  PublicSubnetCidr:
    Type: String
    Default: 10.0.1.0/24
    Description: CIDR block for the public subnet

  PrivateSubnetCidr:
    Type: String
    Default: 10.1.1.0/24
    Description: CIDR block for the private subnet

  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Default: devops
    Description: EC2 KeyPair for SSH access to the bastion host

  RemoteAccessCidr:
    Type: String
    Default: 104.28.111.171/32  # Replace with your actual home IP
    Description: Bastion-Host SSH Access CIDR block (IP Address)

Mappings:
  RegionMap:
    us-east-1:
      AMI: ami-0c2b8ca1dad447f8a

Resources:

# ------------------------------------------------------------------------------
# Public VPC Resources
# ------------------------------------------------------------------------------

  PublicVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidrPublic
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: devops-public-vpc
        - Key: DevOps
          Value: true

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref PublicVPC
      CidrBlock: !Ref PublicSubnetCidr
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      Tags:
        - Key: Name
          Value: devops-public-subnet
        - Key: DevOps
          Value: true

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: DevOps-IGW
        - Key: DevOps
          Value: true

  AttachIGW:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref PublicVPC
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref PublicVPC
      Tags:
        - Key: Name
          Value: DevOps-PublicRouteTable
        - Key: DevOps
          Value: true

  PublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociationPublic:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  NatEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: DevOps-NatEIP
        - Key: DevOps
          Value: true

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEIP.AllocationId
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: DevOps-NatGateway
        - Key: DevOps
          Value: true

  BastionEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: DevOps-BastionEIP
        - Key: DevOps
          Value: true

  BastionRemoteAccessSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH from Remote IP to Public EC2
      VpcId: !Ref PublicVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref RemoteAccessCidr
      Tags:
        - Key: Name
          Value: DevOps-RemoteAccessSG
        - Key: DevOps
          Value: true

  EC2InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow public EC2 to access private EC2
      VpcId: !Ref PublicVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref VpcCidrPublic
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref VpcCidrPrivate
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          DestinationSecurityGroupId: !Ref PrivateSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EC2Instance-SG
        - Key: DevOps
          Value: true

  BastionENI:
    Type: AWS::EC2::NetworkInterface
    Properties:
      SubnetId: !Ref PublicSubnet
      Description: Bastion ENI for Public Subnet
      GroupSet:
        - !Ref EC2InstanceSecurityGroup
        - !Ref BastionRemoteAccessSG
      Tags:
        - Key: Name
          Value: DevOps-BastionENI
        - Key: DevOps
          Value: true

  BastionEIPAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !GetAtt BastionEIP.AllocationId
      NetworkInterfaceId: !Ref BastionENI

  EC2PublicInstance:
    Type: AWS::EC2::Instance
    DependsOn:
      - BastionENI
      - BastionEIPAssociation
    Properties:
      InstanceType: t3.micro
      ImageId: !FindInMap [RegionMap, !Ref "AWS::Region", AMI]
      KeyName: !Ref KeyName
      IamInstanceProfile: !Ref SSMInstanceProfile
      NetworkInterfaces:
        - DeviceIndex: 0
          NetworkInterfaceId: !Ref BastionENI
      Tags:
        - Key: Name
          Value: DevOps-EC2-Public
        - Key: DevOps
          Value: true

# ------------------------------------------------------------------------------
# Private VPC Resources
# ------------------------------------------------------------------------------

  PrivateVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidrPrivate
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: devops-private-vpc
        - Key: DevOps
          Value: true

  PrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref PrivateVPC
      CidrBlock: !Ref PrivateSubnetCidr
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      Tags:
        - Key: Name
          Value: devops-private-subnet
        - Key: DevOps
          Value: true

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref PrivateVPC
      Tags:
        - Key: Name
          Value: DevOps-PrivateRouteTable
        - Key: DevOps
          Value: true

  SubnetRouteTableAssociationPrivate:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet
      RouteTableId: !Ref PrivateRouteTable

  PrivateVPCEndpointSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Access control for private VPC endpoints
      VpcId: !Ref PrivateVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: DevOps-VPCInterfaceEndpointSG
        - Key: DevOps
          Value: true

  PrivateSSMEndpointSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Access control for SSM VPC interface endpoints
      VpcId: !Ref PrivateVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.1.0.0/16
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        # - IpProtocol: tcp
        #   FromPort: 443
        #   ToPort: 443
        #   SourceSecurityGroupId: !Ref EC2PrivateInstanceSecurityGroup
        # - IpProtocol: tcp
        #   FromPort: 443
        #   ToPort: 443
        #   SourceSecurityGroupId: !Ref EC2InstanceSecurityGroup
      Tags:
        - Key: Name
          Value: DevOps-SSMEndpointSG
        - Key: DevOps
          Value: true

# ------------------------------------------------------------------------------
# Private VPC Endpoints
# ------------------------------------------------------------------------------

  EndpointS3:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref PrivateVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.s3
      RouteTableIds:
        - !Ref PrivateRouteTable
      VpcEndpointType: Gateway
      Tags:
        - Key: Name
          Value: DevOps-EndpointS3
        - Key: DevOps
          Value: true

  EndpointRDS:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref PrivateVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.rds
      SubnetIds:
        - !Ref PrivateSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref PrivateVPCEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointRDS
        - Key: DevOps
          Value: true

  EndpointSecretsManager:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref PrivateVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.secretsmanager
      SubnetIds:
        - !Ref PrivateSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref PrivateVPCEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointSecretsManager
        - Key: DevOps
          Value: true

  EndpointSSM:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref PrivateVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ssm
      SubnetIds:
        - !Ref PrivateSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref PrivateSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointSSM
        - Key: DevOps
          Value: true

  EndpointSSMMessages:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref PrivateVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ssmmessages
      SubnetIds:
        - !Ref PrivateSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref PrivateSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointSSMMessages
        - Key: DevOps
          Value: true

  EndpointEC2Messages:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref PrivateVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ec2messages
      SubnetIds:
        - !Ref PrivateSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref PrivateSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointEC2Messages
        - Key: DevOps
          Value: true

  EndpointCloudWatchLogs:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref PrivateVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.logs
      SubnetIds:
        - !Ref PrivateSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref PrivateVPCEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointCloudWatchLogs
        - Key: DevOps
          Value: true

  EndpointEC2:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref PrivateVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ec2
      SubnetIds:
        - !Ref PrivateSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref PrivateVPCEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointEC2
        - Key: DevOps
          Value: true

# ------------------------------------------------------------------------------
# Transit Gateway, Peering, and Routing
# ------------------------------------------------------------------------------

  TransitGateway:
    Type: AWS::EC2::TransitGateway
    Properties:
      Description: Transit Gateway for VPC interconnect
      AutoAcceptSharedAttachments: enable
      DefaultRouteTableAssociation: enable
      Tags:
        - Key: Name
          Value: DevOps-TransitGateway
        - Key: DevOps
          Value: true

  TGWAttachmentPublic:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !Ref TransitGateway
      VpcId: !Ref PublicVPC
      SubnetIds:
        - !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: DevOps-TGWAttachment-Public
        - Key: DevOps
          Value: true

  TGWAttachmentPrivate:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !Ref TransitGateway
      VpcId: !Ref PrivateVPC
      SubnetIds:
        - !Ref PrivateSubnet
      Tags:
        - Key: Name
          Value: DevOps-TGWAttachment-Private
        - Key: DevOps
          Value: true

  VPCPeeringConnection:
    Type: AWS::EC2::VPCPeeringConnection
    Properties:
      VpcId: !Ref PublicVPC
      PeerVpcId: !Ref PrivateVPC
      Tags:
        - Key: Name
          Value: DevOps-VPCPeering-PublicPrivate
        - Key: DevOps
          Value: true

  PublicPeerRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: !Ref VpcCidrPrivate
      VpcPeeringConnectionId: !Ref VPCPeeringConnection

  PrivatePeerRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: !Ref VpcCidrPublic
      VpcPeeringConnectionId: !Ref VPCPeeringConnection

  PrivateRouteOut:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      VpcPeeringConnectionId: !Ref VPCPeeringConnection

# ------------------------------------------------------------------------------
# EC2 IAM Role / Profile (shared)
# ------------------------------------------------------------------------------

  SSMInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: [ec2.amazonaws.com]
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: DevOps
          Value: true

  SSMInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref SSMInstanceRole

# ------------------------------------------------------------------------------
# Private EC2 Instance
# ------------------------------------------------------------------------------

  EC2PrivateInstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH from Public EC2
      VpcId: !Ref PrivateVPC
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          DestinationSecurityGroupId: !Ref PrivateSSMEndpointSG
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref VpcCidrPublic
      Tags:
        - Key: Name
          Value: DevOps-EC2InstancePrivate-SG
        - Key: DevOps
          Value: true

  EC2PrivateInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.micro
      ImageId: !FindInMap [RegionMap, !Ref "AWS::Region", AMI]
      KeyName: !Ref KeyName
      IamInstanceProfile: !Ref SSMInstanceProfile
      NetworkInterfaces:
        - DeviceIndex: 0
          SubnetId: !Ref PrivateSubnet
          GroupSet:
            - !Ref EC2PrivateInstanceSecurityGroup
      Tags:
        - Key: Name
          Value: DevOps-EC2-Private
        - Key: DevOps
          Value: true

# ------------------------------------------------------------------------------
# DevOps VPC Resources
# ------------------------------------------------------------------------------

  DevOpsVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.2.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: devops-locked-vpc
        - Key: DevOps
          Value: true

  DevOpsSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref DevOpsVPC
      CidrBlock: 10.2.1.0/24
      MapPublicIpOnLaunch: false
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      Tags:
        - Key: Name
          Value: devops-locked-subnet
        - Key: DevOps
          Value: true

  DevOpsRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref DevOpsVPC
      Tags:
        - Key: Name
          Value: DevOps-LockedRouteTable
        - Key: DevOps
          Value: true

  DevOpsRouteDefault:
    Type: AWS::EC2::Route
    DependsOn: TGWAttachmentDevOps
    Properties:
      RouteTableId: !Ref DevOpsRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      TransitGatewayId: !Ref TransitGateway

  SubnetRouteTableAssociationDevOps:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref DevOpsSubnet
      RouteTableId: !Ref DevOpsRouteTable

  TGWAttachmentDevOps:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !Ref TransitGateway
      VpcId: !Ref DevOpsVPC
      SubnetIds:
        - !Ref DevOpsSubnet
      Tags:
        - Key: Name
          Value: DevOps-TGWAttachment-DevOps
        - Key: DevOps
          Value: true

# ------------------------------------------------------------------------------
# DevOps Security Groups
# ------------------------------------------------------------------------------

  DevOpsSSMEndpointSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTPS from DevOps subnet to SSM endpoints
      VpcId: !Ref DevOpsVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.2.0.0/16
      # SecurityGroupIngress:
      #   - IpProtocol: tcp
      #     FromPort: 443
      #     ToPort: 443
      #     SourceSecurityGroupId: !Ref DevOpsSSMEndpointSG
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      # SecurityGroupEgress:
      #   - IpProtocol: tcp
      #     FromPort: 443
      #     ToPort: 443
      #     DestinationSecurityGroupId: !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-SSMEndpointSG-DevOps
        - Key: DevOps
          Value: true

# ------------------------------------------------------------------------------
# DevOps EC2 Instance
# ------------------------------------------------------------------------------

  EC2DevOpsInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.micro
      ImageId: !FindInMap [RegionMap, !Ref "AWS::Region", AMI]
      KeyName: !Ref KeyName
      IamInstanceProfile: !Ref SSMInstanceProfile
      NetworkInterfaces:
        - DeviceIndex: 0
          SubnetId: !Ref DevOpsSubnet
          AssociatePublicIpAddress: false
          GroupSet:
            - !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EC2-DevOps
        - Key: DevOps
          Value: true

# ------------------------------------------------------------------------------
# DevOps VPC Endpoints
# ------------------------------------------------------------------------------

  DevOpsEndpointS3:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref DevOpsVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.s3
      RouteTableIds:
        - !Ref DevOpsRouteTable
      VpcEndpointType: Gateway
      Tags:
        - Key: Name
          Value: DevOps-EndpointS3
        - Key: DevOps
          Value: true

  DevOpsEndpointRDS:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref DevOpsVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.rds
      SubnetIds:
        - !Ref DevOpsSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointRDS
        - Key: DevOps
          Value: true

  DevOpsEndpointSecretsManager:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref DevOpsVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.secretsmanager
      SubnetIds:
        - !Ref DevOpsSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointSecretsManager
        - Key: DevOps
          Value: true

  DevOpsEndpointSSM:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref DevOpsVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ssm
      SubnetIds:
        - !Ref DevOpsSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointSSM
        - Key: DevOps
          Value: true

  DevOpsEndpointSSMMessages:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref DevOpsVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ssmmessages
      SubnetIds:
        - !Ref DevOpsSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointSSMMessages
        - Key: DevOps
          Value: true

  DevOpsEndpointEC2Messages:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref DevOpsVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ec2messages
      SubnetIds:
        - !Ref DevOpsSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointEC2Messages
        - Key: DevOps
          Value: true

  DevOpsEndpointCloudWatchLogs:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref DevOpsVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.logs
      SubnetIds:
        - !Ref DevOpsSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointCloudWatchLogs
        - Key: DevOps
          Value: true

  DevOpsEndpointEC2:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref DevOpsVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ec2
      SubnetIds:
        - !Ref DevOpsSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointEC2
        - Key: DevOps
          Value: true

# ------------------------------------------------------------------------------
# DevOps Optional VPC Endpoints (for Full Coverage)
# ------------------------------------------------------------------------------

  DevOpsEndpointKMS:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref DevOpsVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.kms
      SubnetIds:
        - !Ref DevOpsSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointKMS
        - Key: DevOps
          Value: true

  # DevOpsEndpointSSMGuiConnect:
  #   Type: AWS::EC2::VPCEndpoint
  #   Properties:
  #     VpcId: !Ref DevOpsVPC
  #     ServiceName: !Sub com.amazonaws.${AWS::Region}.ssm-guiconnect
  #     SubnetIds:
  #       - !Ref DevOpsSubnet
  #     VpcEndpointType: Interface
  #     PrivateDnsEnabled: true
  #     SecurityGroupIds:
  #       - !Ref DevOpsSSMEndpointSG
  #     Tags:
  #       - Key: Name
  #         Value: DevOps-EndpointSSMGuiConnect
  #       - Key: DevOps
  #         Value: true

  DevOpsEndpointMonitoring:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref DevOpsVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.monitoring
      SubnetIds:
        - !Ref DevOpsSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointMonitoring
        - Key: DevOps
          Value: true

  DevOpsEndpointBackup:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref DevOpsVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.backup
      SubnetIds:
        - !Ref DevOpsSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointBackup
        - Key: DevOps
          Value: true

  DevOpsEndpointEvents:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref DevOpsVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.events
      SubnetIds:
        - !Ref DevOpsSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointEvents
        - Key: DevOps
          Value: true

  DevOpsEndpointSNS:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref DevOpsVPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.sns
      SubnetIds:
        - !Ref DevOpsSubnet
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - !Ref DevOpsSSMEndpointSG
      Tags:
        - Key: Name
          Value: DevOps-EndpointSNS
        - Key: DevOps
          Value: true

# ------------------------------------------------------------------------------
# Outputs
# ------------------------------------------------------------------------------

Outputs:

  # VPCs
  PublicVPCId:
    Description: Public VPC ID
    Value: !Ref PublicVPC
    Export:
      Name: DevOps-PublicVPCId

  PrivateVPCId:
    Description: Private VPC ID
    Value: !Ref PrivateVPC
    Export:
      Name: DevOps-PrivateVPCId

  DevOpsVPCId:
    Description: DevOps VPC ID
    Value: !Ref DevOpsVPC
    Export:
      Name: DevOps-DevOpsVPCId

  # Subnets
  PublicSubnetId:
    Description: Public Subnet ID
    Value: !Ref PublicSubnet

  PrivateSubnetId:
    Description: Private Subnet ID
    Value: !Ref PrivateSubnet

  DevOpsSubnetId:
    Description: DevOps Subnet ID
    Value: !Ref DevOpsSubnet

  # Route Tables
  PublicRouteTableId:
    Description: Public Route Table ID
    Value: !Ref PublicRouteTable

  PrivateRouteTableId:
    Description: Private Route Table ID
    Value: !Ref PrivateRouteTable

  DevOpsRouteTableId:
    Description: DevOps Route Table ID
    Value: !Ref DevOpsRouteTable

  # Gateway, IGW, NAT
  InternetGatewayId:
    Description: Internet Gateway ID
    Value: !Ref InternetGateway

  NatGatewayId:
    Description: NAT Gateway ID
    Value: !Ref NatGateway

  NatPublicIP:
    Description: Elastic IP associated with NAT Gateway
    Value: !Ref NatEIP

  # Transit Gateway & Peering
  TransitGatewayId:
    Description: Transit Gateway ID
    Value: !Ref TransitGateway
    Export:
      Name: DevOps-TransitGatewayId

  TGWAttachmentPublicId:
    Description: Transit Gateway Attachment (Public VPC)
    Value: !Ref TGWAttachmentPublic

  TGWAttachmentPrivateId:
    Description: Transit Gateway Attachment (Private VPC)
    Value: !Ref TGWAttachmentPrivate

  TGWAttachmentDevOpsId:
    Description: Transit Gateway Attachment (DevOps VPC)
    Value: !Ref TGWAttachmentDevOps

  VPCPeeringId:
    Description: VPC Peering Connection ID
    Value: !Ref VPCPeeringConnection

  # Bastion Host
  BastionEIP:
    Description: Bastion Host Elastic IP
    Value: !Ref BastionEIP

  BastionPublicIP:
    Description: Elastic IP associated with Bastion Host
    Value: !Ref BastionEIP

  BastionENIId:
    Description: Bastion Elastic Network Interface ID
    Value: !Ref BastionENI

  # EC2 Instances
  EC2PublicInstanceId:
    Description: Public EC2 Instance ID
    Value: !Ref EC2PublicInstance

  EC2PrivateInstanceId:
    Description: Private EC2 Instance ID
    Value: !Ref EC2PrivateInstance

  EC2DevOpsInstanceId:
    Description: DevOps EC2 Instance ID
    Value: !Ref EC2DevOpsInstance

  # IAM Role & Instance Profile
  SSMRoleName:
    Description: Name of the IAM Role used for SSM access
    Value: !Ref SSMInstanceRole

  SSMRoleArn:
    Description: ARN of the IAM Role used for SSM access
    Value: !GetAtt SSMInstanceRole.Arn

  SSMInstanceProfile:
    Description: Instance Profile for SSM-managed EC2s
    Value: !Ref SSMInstanceProfile

  # Private VPC Endpoints
  VPCEndpointS3Id:
    Description: Gateway VPC Endpoint for S3 (Private VPC)
    Value: !Ref EndpointS3

  VPCEndpointSecretsManagerId:
    Description: Interface Endpoint for Secrets Manager (Private VPC)
    Value: !Ref EndpointSecretsManager

  VPCEndpointSSMId:
    Description: Interface Endpoint for SSM (Private VPC)
    Value: !Ref EndpointSSM

  VPCEndpointEC2MessagesId:
    Description: Interface Endpoint for EC2 Messages (Private VPC)
    Value: !Ref EndpointEC2Messages

  # DevOps VPC Endpoints
  DevOpsEndpointSSMId:
    Description: Interface Endpoint for SSM (DevOps VPC)
    Value: !Ref DevOpsEndpointSSM

  DevOpsEndpointCloudWatchLogsId:
    Description: Interface Endpoint for CloudWatch Logs (DevOps VPC)
    Value: !Ref DevOpsEndpointCloudWatchLogs

  DevOpsEndpointKMSId:
    Description: Interface Endpoint for KMS (DevOps VPC)
    Value: !Ref DevOpsEndpointKMS

  DevOpsEndpointSecretsManagerId:
    Description: Interface Endpoint for Secrets Manager (DevOps VPC)
    Value: !Ref DevOpsEndpointSecretsManager

  DevOpsEndpointEC2MessagesId:
    Description: Interface Endpoint for EC2 Messages (DevOps VPC)
    Value: !Ref DevOpsEndpointEC2Messages

  DevOpsEndpointSSMMessagesId:
    Description: Interface Endpoint for SSM Messages (DevOps VPC)
    Value: !Ref DevOpsEndpointSSMMessages

  DevOpsEndpointMonitoringId:
    Description: Interface Endpoint for Monitoring (DevOps VPC)
    Value: !Ref DevOpsEndpointMonitoring

  DevOpsEndpointBackupId:
    Description: Interface Endpoint for Backup (DevOps VPC)
    Value: !Ref DevOpsEndpointBackup

  DevOpsEndpointEventsId:
    Description: Interface Endpoint for Events (DevOps VPC)
    Value: !Ref DevOpsEndpointEvents

  DevOpsEndpointSNSId:
    Description: Interface Endpoint for SNS (DevOps VPC)
    Value: !Ref DevOpsEndpointSNS

  # ARN Additions (preserved from last version)
  # --- Subnet ARNs ---
  PublicSubnetArn:
    Description: ARN of the Public Subnet
    Value: !Ref PublicSubnet  # No native Arn; use the ID and reconstruct ARN if needed

  PrivateSubnet:
    Description: ARN of the Private Subnet
    Value: !Ref PrivateSubnet

  DevOpsSubnet:
    Description: ARN of the DevOps Subnet
    Value: !Ref DevOpsSubnet

  # --- Route Table ARNs ---
  PublicRouteTable:
    Description: ARN of the Public Route Table
    Value: !Ref PublicRouteTable

  PrivateRouteTable:
    Description: ARN of the Private Route Table
    Value: !Ref PrivateRouteTable

  DevOpsRouteTable:
    Description: ARN of the DevOps Route Table
    Value: !Ref DevOpsRouteTable

  # --- Gateway, IGW, NAT ARNs ---
  InternetGateway:
    Description: Internet Gateway ID (No ARN in CFN)
    Value: !Ref InternetGateway

  NatGateway:
    Description: NAT Gateway ID (No ARN in CFN)
    Value: !Ref NatGateway

  # --- Bastion ENI ARN ---
  BastionENI:
    Description: Elastic Network Interface ID
    Value: !Ref BastionENI

  # --- Private VPC Endpoint ARNs ---
  VPCEndpointS3:
    Description: ID of the Gateway VPC Endpoint for S3
    Value: !Ref EndpointS3

  VPCEndpointSecretsManager:
    Description: ID of the Interface Endpoint for Secrets Manager
    Value: !Ref EndpointSecretsManager

  VPCEndpointSSM:
    Description: ID of the Interface Endpoint for SSM
    Value: !Ref EndpointSSM

  VPCEndpointEC2Messages:
    Description: ID of the Interface Endpoint for EC2 Messages
    Value: !Ref EndpointEC2Messages

  # --- DevOps VPC Endpoint ARNs ---
  DevOpsEndpointSSM:
    Description: ID of the Interface Endpoint for SSM
    Value: !Ref DevOpsEndpointSSM

  DevOpsEndpointCloudWatchLogs:
    Description: ID of the Interface Endpoint for CloudWatch Logs
    Value: !Ref DevOpsEndpointCloudWatchLogs

  DevOpsEndpointKMS:
    Description: ID of the Interface Endpoint for KMS
    Value: !Ref DevOpsEndpointKMS

  DevOpsEndpointSecretsManager:
    Description: ID of the Interface Endpoint for Secrets Manager
    Value: !Ref DevOpsEndpointSecretsManager

  DevOpsEndpointEC2Messages:
    Description: ID of the Interface Endpoint for EC2 Messages
    Value: !Ref DevOpsEndpointEC2Messages

  DevOpsEndpointSSMMessages:
    Description: ID of the Interface Endpoint for SSM Messages
    Value: !Ref DevOpsEndpointSSMMessages

  DevOpsEndpointMonitoring:
    Description: ID of the Interface Endpoint for Monitoring
    Value: !Ref DevOpsEndpointMonitoring

  DevOpsEndpointBackup:
    Description: ID of the Interface Endpoint for Backup
    Value: !Ref DevOpsEndpointBackup

  DevOpsEndpointEvents:
    Description: ID of the Interface Endpoint for Events
    Value: !Ref DevOpsEndpointEvents

  DevOpsEndpointSNS:
    Description: ID of the Interface Endpoint for SNS
    Value: !Ref DevOpsEndpointSNS
